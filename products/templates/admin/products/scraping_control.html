{% extends "admin/base_site.html" %}
{% load admin_urls static admin_list %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
.scraping-section {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 20px;
    margin: 20px 0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.scraping-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
    margin: 20px 0;
}
.form-group {
    margin-bottom: 15px;
}
.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
}
.form-group input, .form-group select {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}
.btn {
    display: inline-block;
    padding: 10px 20px;
    margin: 5px;
    border: none;
    border-radius: 4px;
    text-decoration: none;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.2s;
}
.btn-success {
    background: #28a745;
    color: white;
}
.btn-success:hover {
    background: #1e7e34;
}
.btn-primary {
    background: #007cba;
    color: white;
}
.btn-primary:hover {
    background: #005a87;
}
.btn-warning {
    background: #ffc107;
    color: #212529;
}
.btn-warning:hover {
    background: #e0a800;
}
.btn-secondary {
    background: #6c757d;
    color: white;
}
.btn-secondary:hover {
    background: #545b62;
}
.status-message {
    padding: 10px;
    border-radius: 4px;
    margin: 10px 0;
    display: none;
}
.status-success {
    background: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
}
.status-error {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
}
.brand-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 10px;
    margin: 15px 0;
}
.brand-item {
    background: #e3f2fd;
    color: #1976d2;
    padding: 8px 12px;
    border-radius: 4px;
    text-align: center;
    font-size: 0.9em;
}
.scraped-brand {
    background: #c8e6c9;
    color: #2e7d32;
}
.loading {
    display: none;
    text-align: center;
    padding: 20px;
}
.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #007cba;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto 10px;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block content %}
<div class="content-main">
    <h1>{{ title }}</h1>
    
    <!-- Status Messages -->
    <div id="status-message" class="status-message"></div>
    
    <!-- Loading Indicator -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Scraping in progress... This may take a few minutes.</p>
    </div>

    <!-- Available Brands Overview -->
    <div class="scraping-section">
        <h3>üè¢ Available Brands</h3>
        <p>These brands are available for scraping from bathingbrands.com:</p>
        
        <div class="brand-list">
            {% for brand in known_brands %}
                {% if brand in scraped_brands %}
                    <div class="brand-item scraped-brand">‚úÖ {{ brand }}</div>
                {% else %}
                    <div class="brand-item">{{ brand }}</div>
                {% endif %}
            {% endfor %}
        </div>
        
        <p style="margin-top: 15px; color: #666; font-size: 0.9em;">
            ‚úÖ Green brands have products in the database ‚Ä¢ Regular brands are available for scraping
        </p>
    </div>

    <!-- Scraping Controls -->
    <div class="scraping-grid">
        <!-- Brand Scraping -->
        <div class="scraping-section">
            <h3>üè¢ Scrape by Brand</h3>
            <p>Scrape all products from a specific brand</p>
            
            <form id="brand-scrape-form">
                <div class="form-group">
                    <label for="brand-select">Select Brand:</label>
                    <select id="brand-select" name="brand" required>
                        <option value="">Choose a brand...</option>
                        {% for brand in known_brands %}
                            <option value="{{ brand }}">{{ brand }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="brand-limit">Product Limit:</label>
                    <input type="number" id="brand-limit" name="limit" value="10" min="1" max="100">
                    <small style="color: #666;">Maximum number of products to scrape</small>
                </div>
                
                <button type="submit" class="btn btn-success">üöÄ Scrape Brand</button>
            </form>
        </div>

        <!-- Category Scraping -->
        <div class="scraping-section">
            <h3>üìÇ Scrape by Category</h3>
            <p>Scrape products from a specific brand and category</p>
            
            <form id="category-scrape-form">
                <div class="form-group">
                    <label for="category-brand-select">Select Brand:</label>
                    <select id="category-brand-select" name="brand" required>
                        <option value="">Choose a brand...</option>
                        {% for brand in known_brands %}
                            <option value="{{ brand }}">{{ brand }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="category-input">Category Name:</label>
                    <input type="text" id="category-input" name="category" placeholder="e.g., Electric Heaters, Controls" required>
                    <small style="color: #666;">Enter the category name as it appears on the website</small>
                </div>
                
                <div class="form-group">
                    <label for="category-limit">Product Limit:</label>
                    <input type="number" id="category-limit" name="limit" value="5" min="1" max="50">
                </div>
                
                <button type="submit" class="btn btn-primary">üìÇ Scrape Category</button>
            </form>
        </div>

        <!-- Single Product Scraping -->
        <div class="scraping-section">
            <h3>üõçÔ∏è Scrape Single Product</h3>
            <p>Scrape a specific product by URL</p>
            
            <form id="product-scrape-form">
                <div class="form-group">
                    <label for="product-url">Product URL:</label>
                    <input type="url" id="product-url" name="url" placeholder="https://www.bathingbrands.com/..." required>
                    <small style="color: #666;">Full URL to the product page</small>
                </div>
                
                <button type="submit" class="btn btn-warning">üõçÔ∏è Scrape Product</button>
            </form>
        </div>

        <!-- Quick Actions -->
        <div class="scraping-section">
            <h3>‚ö° Quick Actions</h3>
            <p>Common scraping operations</p>
            
            <div style="margin: 15px 0;">
                <button onclick="scrapePopularBrands()" class="btn btn-success">
                    üî• Scrape Popular Brands (HUUM, Harvia, Mr.Steam)
                </button>
            </div>
            
            <div style="margin: 15px 0;">
                <button onclick="scrapeAllBrands()" class="btn btn-primary">
                    üåü Scrape All Brands (Limited)
                </button>
            </div>
            
            <div style="margin: 15px 0;">
                <a href="{% url 'admin:products_brand_hierarchy' %}" class="btn btn-secondary">
                    üìä View Hierarchy Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<script>
// CSRF token for Django
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

function showStatus(message, isError = false) {
    const statusDiv = document.getElementById('status-message');
    statusDiv.textContent = message;
    statusDiv.className = 'status-message ' + (isError ? 'status-error' : 'status-success');
    statusDiv.style.display = 'block';
    
    setTimeout(() => {
        statusDiv.style.display = 'none';
    }, 5000);
}

function showLoading(show = true) {
    document.getElementById('loading').style.display = show ? 'block' : 'none';
}

// Brand scraping form
document.getElementById('brand-scrape-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    formData.append('action', 'scrape_brand');
    formData.append('brand', document.getElementById('brand-select').value);
    formData.append('limit', document.getElementById('brand-limit').value);
    formData.append('csrfmiddlewaretoken', csrftoken);
    
    showLoading(true);
    
    fetch('{% url "admin:products_scraping_control" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        showLoading(false);
        if (data.status === 'success') {
            showStatus(data.message);
        } else {
            showStatus(data.message, true);
        }
    })
    .catch(error => {
        showLoading(false);
        showStatus('Error: ' + error.message, true);
    });
});

// Category scraping form
document.getElementById('category-scrape-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    formData.append('action', 'scrape_category');
    formData.append('brand', document.getElementById('category-brand-select').value);
    formData.append('category', document.getElementById('category-input').value);
    formData.append('limit', document.getElementById('category-limit').value);
    formData.append('csrfmiddlewaretoken', csrftoken);
    
    showLoading(true);
    
    fetch('{% url "admin:products_scraping_control" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        showLoading(false);
        if (data.status === 'success') {
            showStatus(data.message);
        } else {
            showStatus(data.message, true);
        }
    })
    .catch(error => {
        showLoading(false);
        showStatus('Error: ' + error.message, true);
    });
});

// Product scraping form
document.getElementById('product-scrape-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    formData.append('action', 'scrape_product');
    formData.append('url', document.getElementById('product-url').value);
    formData.append('csrfmiddlewaretoken', csrftoken);
    
    showLoading(true);
    
    fetch('{% url "admin:products_scraping_control" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        showLoading(false);
        if (data.status === 'success') {
            showStatus(data.message);
        } else {
            showStatus(data.message, true);
        }
    })
    .catch(error => {
        showLoading(false);
        showStatus('Error: ' + error.message, true);
    });
});

// Quick action functions
function scrapePopularBrands() {
    const brands = ['HUUM', 'Harvia', 'Mr.Steam'];
    showLoading(true);
    showStatus('Starting to scrape popular brands...');
    
    // Scrape each brand sequentially
    let currentBrand = 0;
    
    function scrapeNextBrand() {
        if (currentBrand >= brands.length) {
            showLoading(false);
            showStatus('Completed scraping all popular brands!');
            return;
        }
        
        const brand = brands[currentBrand];
        const formData = new FormData();
        formData.append('action', 'scrape_brand');
        formData.append('brand', brand);
        formData.append('limit', '5');
        formData.append('csrfmiddlewaretoken', csrftoken);
        
        fetch('{% url "admin:products_scraping_control" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            showStatus(`Completed ${brand}: ${data.message}`);
            currentBrand++;
            setTimeout(scrapeNextBrand, 2000); // Wait 2 seconds between brands
        })
        .catch(error => {
            showStatus(`Error scraping ${brand}: ${error.message}`, true);
            currentBrand++;
            setTimeout(scrapeNextBrand, 2000);
        });
    }
    
    scrapeNextBrand();
}

function scrapeAllBrands() {
    if (confirm('This will scrape a limited number of products from all brands. This may take a long time. Continue?')) {
        showLoading(true);
        showStatus('Starting to scrape all brands with limited products...');
        
        // This would need to be implemented as a background task in a real application
        showStatus('All brands scraping started. Check back later for results.');
    }
}
</script>
{% endblock %} 